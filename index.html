<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KFUPM Staff Evaluation Analysis Tool</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#115f66;
      --secondary:#009767;
      --light-bg:#eef2f7;
      --ink:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0;background:var(--light-bg);color:var(--ink);
    }
    header{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;padding:28px 20px;text-align:center;
      font-size:26px;font-weight:600;letter-spacing:.3px;
      box-shadow:0 6px 20px rgba(0,0,0,.12);
    }
    .container{width:min(1100px,90%);margin:22px auto}
    .section{
      background:var(--card);padding:22px;border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);margin-top:22px;
      animation:fadeIn .35s ease;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    h2{color:var(--primary);margin:0 0 12px}
    p.help{color:var(--muted);margin:6px 0 14px}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=file],input[type=number]{
      width:100%;padding:12px;border:1px solid #d1d5db;border-radius:10px;margin-top:6px;
      font-size:15px;background:#fff;
    }
    button{
      background:var(--primary);color:#fff;border:none;border-radius:10px;
      padding:12px 20px;font-size:15px;font-weight:600;cursor:pointer;margin-top:12px;
      transition:all .25s ease;box-shadow:0 6px 14px rgba(17,95,102,.25);
    }
    button:hover{background:var(--secondary);transform:translateY(-1px)}
    .status{font-weight:600;color:var(--secondary);margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:14px;font-size:14px}
    thead th{
      background:var(--primary);color:#fff;padding:12px;text-align:left;position:sticky;top:0;
    }
    tbody td{padding:10px;border-bottom:1px solid #e5e7eb}
    .count-box{
      background:#ddf3e9;border-left:6px solid var(--secondary);
      padding:10px 12px;border-radius:10px;margin:6px 0 12px;font-weight:600;
    }
    .badge{
      display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;
    }
    .badge-ok{background:#e8f5e9;color:#1b5e20;border:1px solid #a5d6a7}
    .badge-warn{background:#fff3cd;color:#7a5a00;border:1px solid #ffe69c}
    .grid{
      display:grid;grid-template-columns:1fr;gap:18px;
    }
    @media (min-width:900px){
      .grid{grid-template-columns:1fr 1fr}
    }
    canvas{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .small{font-size:13px}
  </style>
</head>
<body>

<header>
  KFUPM Staff Evaluation Analysis Tool
</header>

<div class="container">

  <!-- Upload -->
  <div class="section">
    <h2>Upload Excel Files</h2>
    <p class="help">Upload the three categories with headers: <strong>KFUPM ID</strong>, <strong>Name</strong>, <strong>Department</strong>, <strong>Overall Score</strong>, <strong>Total (100)</strong>.</p>

    <label>Staff Professional</label>
    <input type="file" id="fileProfessional" accept=".xlsx,.xls" />

    <label>Staff Support</label>
    <input type="file" id="fileSupport" accept=".xlsx,.xls" />

    <label>Staff Chief</label>
    <input type="file" id="fileChief" accept=".xlsx,.xls" />

    <button onclick="loadFiles()">Load Files</button>
    <div id="fileStatus" class="status"></div>
  </div>

  <!-- Search -->
  <div class="section">
    <h2>Search Employee</h2>
    <div class="flex">
      <input type="number" id="searchID" placeholder="Enter KFUPM ID" />
      <button onclick="searchEmployee()">Search</button>
    </div>
    <p class="small muted">The comparison includes only employees from the <strong>same Department</strong> and the <strong>same Category</strong>.</p>
  </div>

  <!-- Employee Info -->
  <div id="employeeInfo" class="section" style="display:none;">
    <h2>Employee Information</h2>
    <div class="flex">
      <div><strong>Name:</strong> <span id="empName"></span></div>
      <div><strong>Department:</strong> <span id="empDept"></span></div>
      <div><strong>Category:</strong> <span id="empCat"></span></div>
      <div><strong>Overall Score:</strong> <span id="empScore"></span></div>
      <div><strong>Total (100):</strong> <span id="empTotal"></span></div>
    </div>
  </div>

  <!-- Department Comparison -->
  <div id="deptComparison" class="section" style="display:none;">
    <h2>Department Comparison</h2>
    <div class="count-box">
      Employees in this department (same category): <span id="deptCount"></span>
    </div>

    <table id="deptTable">
      <thead>
        <tr>
          <th>KFUPM ID</th>
          <th>Name</th>
          <th>Total (100)</th>
          <th>Overall Score</th>
          <th>Flag</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Analysis -->
  <div id="deptAnalysis" class="section" style="display:none;">
    <h2>Department Score Analysis</h2>
    <div class="flex small muted">
      <div><strong>Average Overall Score:</strong> <span id="avgScore"></span></div>
    </div>

    <div class="grid" style="margin-top:10px;">
      <div>
        <p class="small muted"><strong>Overall Score Distribution</strong> (1–4)</p>
        <canvas id="scoreChart" height="180"></canvas>
      </div>
      <div>
        <p class="small muted"><strong>Total (100) Distribution</strong> (0–100, binned)</p>
        <canvas id="totalChart" height="180"></canvas>
      </div>
    </div>
  </div>

  <!-- Recommendation -->
  <div id="recommendation" class="section" style="display:none;">
    <h2>Recommendation</h2>
    <p id="recText"></p>
  </div>
</div>

<script>
  // ====== Config ======
  const COLORS = { primary: "#115f66", secondary: "#009767" };
  const TOTAL_DELTA = 2; // "Similar total" threshold (±2 points)

  // ====== State ======
  let categorized = { Professional: [], Support: [], Chief: [] };
  let allData = [];
  let scoreChartObj = null;
  let totalChartObj = null;

  // ====== Excel Loading Helpers ======
  function readExcelFile(file, category){
    return new Promise((resolve, reject) => {
      if(!file) return resolve([]);
      const reader = new FileReader();
      reader.onload = e => {
        try{
          const workbook = XLSX.read(e.target.result, { type:"binary" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);
          const cleaned = rows.map(r => ({
            id: String(r["KFUPM ID"] ?? "").trim(),
            name: String(r["Name"] ?? "").trim(),
            dept: String(r["Department"] ?? "").trim(),
            score: Number(r["Overall Score"]),
            total: Number(r["Total (100)"]),
            category
          })).filter(x => x.id && x.name && x.dept && !Number.isNaN(x.score) && !Number.isNaN(x.total));
          resolve(cleaned);
        }catch(err){ reject(err); }
      };
      reader.onerror = reject;
      reader.readAsBinaryString(file);
    });
  }

  async function loadFiles(){
    const professional = document.getElementById("fileProfessional").files[0];
