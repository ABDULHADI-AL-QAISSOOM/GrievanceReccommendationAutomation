<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Staff Evaluation Grievance Analysis</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
    --primary:#115f66;
    --secondary:#009767;
    --light:#eef2f7;
    --muted:#6b7280;
}
body{
    font-family:'Inter',sans-serif;
    margin:0;background:var(--light);
}
header{
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    color:white;text-align:center;
    padding:32px;font-size:28px;font-weight:600;
    box-shadow:0 6px 20px rgba(0,0,0,0.15);
}
.container{
    width:90%;max-width:1100px;margin:20px auto;
}
.section{
    background:white;padding:22px;border-radius:14px;
    margin-top:22px;box-shadow:0 6px 18px rgba(0,0,0,0.08);
    animation:fadeIn .3s ease;
}
@keyframes fadeIn{
    from{opacity:0;transform:translateY(10px)}
    to{opacity:1;transform:translateY(0)}
}
h2{color:var(--primary);margin:0 0 12px;}

input[type=file],input[type=number]{
    width:100%;padding:12px;margin-top:6px;
    border-radius:10px;border:1px solid #ccc;
    font-size:15px;
}
button{
    padding:12px 20px;border:none;border-radius:10px;
    font-size:15px;font-weight:600;color:white;
    background:var(--primary);cursor:pointer;margin-top:12px;
    transition:.25s;
}
button:hover{background:var(--secondary);}
.status{margin-top:8px;font-weight:600;color:var(--secondary);}
table{
    width:100%;border-collapse:collapse;margin-top:12px;font-size:14px;
}
th{
    background:var(--primary);color:white;padding:12px;text-align:left;
}
td{padding:10px;border-bottom:1px solid #ddd;}

.badge{
    padding:4px 7px;border-radius:8px;font-size:12px;font-weight:700;
}
.badge-ok{background:#e8f5e9;color:#1B5E20;border:1px solid #A5D6A7;}
.badge-warn{background:#FFF3CD;color:#7A5A00;border:1px solid #FFEE9C;}

.count-box{
    background:#ddf3e9;padding:10px;
    border-left:6px solid var(--secondary);border-radius:10px;
    margin-bottom:10px;font-weight:600;
}
.grid{display:grid;gap:16px;}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr;}}
canvas{background:white;padding:10px;border-radius:12px;}
</style>
</head>

<body>

<header>
    KFUPM Staff Evaluation Analysis Tool
</header>

<div class="container">

<!-- UPLOAD SECTION -->
<div class="section">
    <h2>Upload Excel Files</h2>
    <p style="color:var(--muted)">Required columns: KFUPM ID, Name, Department, Overall Score, Total (100)</p>

    <label>Staff Professional</label>
    <input type="file" id="fileProfessional">

    <label>Staff Support</label>
    <input type="file" id="fileSupport">

    <label>Staff Chief</label>
    <input type="file" id="fileChief">

    <button onclick="loadFiles()">Load Files</button>
    <div id="fileStatus" class="status"></div>
</div>

<!-- SEARCH -->
<div class="section">
    <h2>Search Employee</h2>
    <input type="number" id="searchID" placeholder="Enter KFUPM ID">
    <button onclick="searchEmployee()">Search</button>
</div>

<!-- EMPLOYEE INFO -->
<div id="employeeInfo" class="section" style="display:none;">
    <h2>Employee Information</h2>
    <p><strong>Name:</strong> <span id="empName"></span></p>
    <p><strong>Department:</strong> <span id="empDept"></span></p>
    <p><strong>Category:</strong> <span id="empCat"></span></p>
    <p><strong>Overall Score:</strong> <span id="empScore"></span></p>
    <p><strong>Total (100):</strong> <span id="empTotal"></span></p>
</div>

<!-- DEPARTMENT COMPARISON -->
<div id="deptComparison" class="section" style="display:none;">
    <h2>Department Comparison</h2>

    <div class="count-box">
        Employees in same department & category: <span id="deptCount"></span>
    </div>

    <table id="deptTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Total (100)</th>
                <th>Score</th>
                <th>Flag</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- ANALYSIS -->
<div id="deptAnalysis" class="section" style="display:none;">
    <h2>Department Analysis</h2>

    <p><strong>Average Score:</strong> <span id="avgScore"></span></p>

    <div class="grid">
        <div>
            <p style="color:var(--muted);font-size:14px;">Score Distribution (1–4)</p>
            <canvas id="scoreChart" height="180"></canvas>
        </div>

        <div>
            <p style="color:var(--muted);font-size:14px;">Total (100) Distribution</p>
            <canvas id="totalChart" height="180"></canvas>
        </div>
    </div>
</div>

<!-- RECOMMENDATION -->
<div id="recommendation" class="section" style="display:none;">
    <h2>Recommendation</h2>
    <p id="recText"></p>
</div>

</div>

<script>
let categorized = {Professional:[], Support:[], Chief:[]};
let allData = [];
const TOTAL_DELTA = 2;

async function readExcel(file, category){
    return new Promise(resolve => {
        if(!file) return resolve([]);
        const reader = new FileReader();
        reader.onload = e=>{
            const wb = XLSX.read(e.target.result,{type:"binary"});
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet);
            const cleaned = rows.map(r=>({
                id:String(r["KFUPM ID"]),
                name:r["Name"],
                dept:r["Department"],
                score:Number(r["Overall Score"]),
                total:Number(r["Total (100)"]),
                category
            })).filter(x=>x.id && !isNaN(x.score));
            resolve(cleaned);
        };
        reader.readAsBinaryString(file);
    });
}

async function loadFiles(){
    const fp = document.getElementById("fileProfessional").files[0];
    const fs = document.getElementById("fileSupport").files[0];
    const fc = document.getElementById("fileChief").files[0];

    document.getElementById("fileStatus").textContent = "Loading...";

    categorized.Professional = await readExcel(fp,"Professional");
    categorized.Support = await readExcel(fs,"Support");
    categorized.Chief = await readExcel(fc,"Chief");

    allData = [
        ...categorized.Professional,
        ...categorized.Support,
        ...categorized.Chief
    ];

    document.getElementById("fileStatus").textContent =
        `Loaded ${allData.length} employees.`;
}

function searchEmployee(){
    const id = document.getElementById("searchID").value.trim();
    const emp = allData.find(x=>x.id===id);
    if(!emp){ alert("Employee not found"); return;}

    // DISPLAY EMPLOYEE
    empName.textContent = emp.name;
    empDept.textContent = emp.dept;
    empCat.textContent = emp.category;
    empScore.textContent = emp.score;
    empTotal.textContent = emp.total;
    employeeInfo.style.display = "block";

    // SAME CATEGORY + SAME DEPARTMENT
    const group = categorized[emp.category].filter(x=>x.dept===emp.dept);
    deptCount.textContent = group.length;

    // FLAGGING LOGIC
    const flags = new Set();
    group.forEach(p=>{
        const peers = group.filter(q=>q.id!==p.id &&
            Math.abs(q.total - p.total)<=TOTAL_DELTA);
        const higher = peers.some(q=>q.score > p.score);
        const higherTotalLowerScore = group.some(q=>q.total > p.total && q.score > p.score);
        if(higher || higherTotalLowerScore){
            flags.add(p.id);
        }
    });

    // BUILD TABLE
    const tbody = document.querySelector("#deptTable tbody");
    tbody.innerHTML = "";
    group.forEach(p=>{
        tbody.innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>${p.name}</td>
                <td>${p.total}</td>
                <td>${p.score}</td>
                <td>
                    ${
                        flags.has(p.id)
                        ? `<span class="badge badge-warn">⚠</span>`
                        : `<span class="badge badge-ok">✓</span>`
                    }
                </td>
            </tr>
        `;
    });
    deptComparison.style.display = "block";

    // ANALYSIS
    const avg = group.reduce((s,x)=>s+x.score,0)/group.length;
    avgScore.textContent = avg.toFixed(2);
    deptAnalysis.style.display = "block";

    // SCORE CHART
    const dist = {1:0,2:0,3:0,4:0};
    group.forEach(x=>dist[x.score]++);
    drawScoreChart(dist);

    // TOTAL CHART
    const totals = group.map(x=>x.total);
    drawTotalChart(totals);

    // RECOMMENDATION
    const isFlagged = flags.has(emp.id);
    const normal = (avg>=2 && avg<=3) && Math.abs(emp.score-avg)<=1 && !isFlagged;

    recText.textContent = normal
      ? `Based on the review of the evaluation of the past 3 years and comparison of the employee’s recent evaluation with peers in the same department, and considering the department’s rating average of ${avg.toFixed(2)}, we recommend no changes in the evaluation score.`
      : `Based on the review of the evaluation of the past 3 years and comparison of the employee’s recent evaluation with peers in the same department, and considering the department’s rating average of ${avg.toFixed(2)}, we recommend a reconsideration of the evaluation score.`;

    recommendation.style.display = "block";
}

let scoreChartObj=null,totalChartObj=null;

function drawScoreChart(dist){
    if(scoreChartObj) scoreChartObj.destroy();
    scoreChartObj = new Chart(scoreChart,{
        type:"bar",
        data:{
            labels:["1","2","3","4"],
            datasets:[{
                data:[dist[1],dist[2],dist[3],dist[4]],
                backgroundColor:["#c62828","#ef6c00","#009767","#115f66"],
                borderRadius:6
            }]
        },
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
}

function drawTotalChart(values){
    if(totalChartObj) totalChartObj.destroy();

    const bins = [
        {label:"0–20",range:[0,20]},
        {label:"21–40",range:[21,40]},
        {label:"41–60",range:[41,60]},
        {label:"61–80",range:[61,80]},
        {label:"81–100",range:[81,100]}
    ];
    const counts = bins.map(b =>
        values.filter(v=>v>=b.range[0] && v<=b.range[1]).length
    );

    totalChartObj = new Chart(totalChart,{
        type:"bar",
        data:{
            labels:bins.map(b=>b.label),
            datasets:[{data:counts,backgroundColor:"#115f66",borderRadius:6}]
        },
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
}
</script>

</body>
</html>
