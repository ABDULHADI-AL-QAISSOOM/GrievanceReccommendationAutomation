<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Evaluation Grievance Analysis</title>

  <!-- Google Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" />

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* YOUR CSS (unchanged)… */
    :root{
      --primary:#115f66;
      --secondary:#009767;
      --light-bg:#eef2f7;
      --ink:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0;background:var(--light-bg);color:var(--ink);
    }
    header{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;padding:28px 20px;text-align:center;
      font-size:26px;font-weight:600;letter-spacing:.3px;
      box-shadow:0 6px 20px rgba(0,0,0,.12);
    }
    .container{width:min(1100px,90%);margin:22px auto}
    .section{
      background:var(--card);padding:22px;border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);margin-top:22px;
      animation:fadeIn .35s ease;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    h2{color:var(--primary);margin:0 0 12px}
    p.help{color:var(--muted);margin:6px 0 14px}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=file],input[type=number]{
      width:100%;padding:12px;margin-top:6px;border-radius:10px;border:1px solid #d1d5db;font-size:15px;background:#fff;
    }
    button{
      background:var(--primary);color:#fff;border:none;border-radius:10px;
      padding:12px 20px;font-size:15px;font-weight:600;cursor:pointer;margin-top:12px;
      transition:all .25s ease;box-shadow:0 6px 14px rgba(17,95,102,.25);
    }
    button:hover{background:var(--secondary);transform:translateY(-1px)}
    .status{font-weight:600;color:var(--secondary);margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:14px;font-size:14px}
    thead th{background:var(--primary);color:#fff;padding:12px;text-align:left;position:sticky;top:0}
    tbody td{padding:10px;border-bottom:1px solid #e5e7eb}
    .count-box{
      background:#ddf3e9;border-left:6px solid var(--secondary);
      padding:10px 12px;border-radius:10px;margin:6px 0 12px;font-weight:600;
    }
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge-ok{background:#e8f5e9;color:#1b5e20;border:1px solid #a5d6a7}
    .badge-warn{background:#fff3cd;color:#7a5a00;border:1px solid #ffe69c}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    canvas{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .small{font-size:13px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fafafa;
    }
  </style>
</head>
<body>

<header>Staff Evaluation Grievance Analysis</header>

<div class="container">

  <!-- Upload Section -->
  <div class="section">
      <h2>Upload Excel Files</h2>

      <label>Staff Professional</label>
      <input type="file" id="fileProfessional">

      <label>Staff Support</label>
      <input type="file" id="fileSupport">

      <label>Staff Chief</label>
      <input type="file" id="fileChief">

      <button onclick="loadFiles()">Load Files</button>
      <div id="fileStatus" class="status"></div>
  </div>

  <!-- Search -->
  <div class="section">
      <h2>Search Employee</h2>
      <div class="flex">
          <input type="number" id="searchID" placeholder="Enter KFUPM ID">
          <button onclick="searchEmployee()">Search</button>
      </div>
      <p class="small muted">Comparison includes employees from same department & category.</p>
  </div>

  <!-- Employee Info -->
  <div id="employeeInfo" class="section" style="display:none;">
      <h2>Employee Information</h2>
      <div class="flex">
        <div class="pill"><strong>Name:</strong> <span id="empName"></span></div>
        <div class="pill"><strong>Department:</strong> <span id="empDept"></span></div>
        <div class="pill"><strong>Category:</strong> <span id="empCat"></span></div>
        <div class="pill"><strong>Overall Score:</strong> <span id="empScore"></span></div>
        <div class="pill"><strong>Total (100):</strong> <span id="empTotal"></span></div>
      </div>
  </div>

  <!-- Comparison Table -->
  <div id="deptComparison" class="section" style="display:none;">
      <h2>Department Comparison</h2>
      <div class="count-box">
        Employees: <span id="deptCount"></span>
      </div>
      <table id="deptTable">
          <thead>
            <tr><th>KFUPM ID</th><th>Name</th><th>Total</th><th>Score</th><th>Flag</th></tr>
          </thead>
          <tbody></tbody>
      </table>
  </div>

  <!-- Recommendation -->
  <div id="recommendation" class="section" style="display:none;">
      <h2>Recommendation</h2>
      <p id="recText"></p>
  </div>

</div>

<script>
/* ===========================================================
   ALL SCRIPT LOGIC (WORKING VERSION)
   Only Case 2 was replaced with the intelligent version.
=========================================================== */

const COLORS = {
  primary: "#115f66",
  secondary: "#009767",
  cat1: "#c62828",
  cat2: "#ef6c00",
  cat3: "#009767",
  cat4: "#115f66",
  cat5: "#6a1b9a"
};

const TOTAL_DELTA = 2;
const VARIATION_STD_THRESHOLD = 10;

let categorized = { Professional: [], Support: [], Chief: [] };
let allData = [];

/* ------------------ Utility functions ------------------ */
function mean(arr){ return arr.reduce((a,b)=>a+b,0) / arr.length; }
function stddev(arr){
  if(arr.length <= 1) return 0;
  const m = mean(arr);
  return Math.sqrt(arr.reduce((s,x)=>s+(x-m)**2,0)/(arr.length-1));
}

/* ------------------ File loading ------------------ */
function readExcelFile(file, category){
  return new Promise(resolve=>{
    if(!file) return resolve([]);
    const reader = new FileReader();
    reader.onload = e=>{
      const wb = XLSX.read(e.target.result, {type:"binary"});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);

      const cleaned = rows.map(r=>({
        id: String(r["KFUPM ID"]||"").trim(),
        name: String(r["Name"]||"").trim(),
        dept: String(r["Department"]||"").trim(),
        score: Number(r["Overall Score"]),
        total: Number(r["Total (100)"]),
        category
      })).filter(x=>x.id && !isNaN(x.score) && !isNaN(x.total));

      resolve(cleaned);
    };
    reader.readAsBinaryString(file);
  });
}

async function loadFiles(){
  const status = document.getElementById("fileStatus");
  status.textContent = "Loading...";

  const pro = document.getElementById("fileProfessional").files[0];
  const sup = document.getElementById("fileSupport").files[0];
  const chf = document.getElementById("fileChief").files[0];

  const [p, s, c] = await Promise.all([
    readExcelFile(pro,"Professional"),
    readExcelFile(sup,"Support"),
    readExcelFile(chf,"Chief")
  ]);

  categorized = {Professional:p, Support:s, Chief:c};
  allData = [...p,...s,...c];

  status.textContent = `Loaded: ${allData.length}`;
}

/* ------------------ Main Search ------------------ */
function searchEmployee(){
  const id = document.getElementById("searchID").value.trim();
  if(!id) return alert("Enter ID");

  const emp = allData.find(e=>e.id === id);
  if(!emp) return alert("Not found");

  document.getElementById("employeeInfo").style.display="block";
  empName.textContent = emp.name;
  empDept.textContent = emp.dept;
  empCat.textContent = emp.category;
  empScore.textContent = emp.score;
  empTotal.textContent = emp.total;

  const group = categorized[emp.category].filter(e=>e.dept === emp.dept);

  deptCount.textContent = group.length;

  /* ------- flagging inconsistencies ------- */
  const flaggedIds = new Set();
  group.forEach(p=>{
    const similar = group.filter(q => q.id!==p.id && Math.abs(q.total - p.total) <= TOTAL_DELTA);
    const lowerHigher = similar.some(q => q.score > p.score);
    if(lowerHigher) flaggedIds.add(p.id);
  });

  /* ------- table ------- */
  const tbody = document.querySelector("#deptTable tbody");
  tbody.innerHTML = "";
  group.sort((a,b)=>b.score - a.score || b.total - a.total);
  group.forEach(p=>{
    const flag = flaggedIds.has(p.id)
      ? `<span class="badge badge-warn">⚠</span>`
      : `<span class="badge badge-ok">✓</span>`;
    tbody.insertAdjacentHTML("beforeend",
      `<tr>
        <td>${p.id}</td><td>${p.name}</td>
        <td>${p.total}</td><td>${p.score}</td><td>${flag}</td>
      </tr>`
    );
  });

  deptComparison.style.display="block";

  /* ------- avg ------- */
  const avg = mean(group.map(g=>g.score));

  /* ------- distribution check ------- */
  const sameScoreTotals = group.filter(g=>g.score===emp.score).map(g=>g.total);
  let withinDistribution = true;

  if(sameScoreTotals.length > 2){
    const sd = stddev(sameScoreTotals);
    const m = mean(sameScoreTotals);
    if(emp.total < m - sd || emp.total > m + sd) withinDistribution = false;
  }

  /* ------------------ Recommendation ------------------ */
  const employeeIsFlagged = flaggedIds.has(emp.id);

  const normal =
    (avg >= 2 && avg <= 3) &&
    Math.abs(emp.score - avg) <= 1 &&
    !employeeIsFlagged &&
    withinDistribution;

  let rec = "";

  if(normal){
    rec = `Based on the review of the evaluation of the past 3 years and comparison of the employee’s recent evaluation with peers in the same department, and considering the department’s rating average of ${avg.toFixed(2)}, we recommend no changes in the evaluation score.`;
  } else {

    /* ================== CASE 2 (INTELLIGENT) ================== */
    let reasons = [];

    // 1. peers with lower total but higher score
    const peersLowerTotalHigherScore = group.filter(p =>
      p.total < emp.total && p.score > emp.score
    );
    if(peersLowerTotalHigherScore.length > 0){
      reasons.push(
        `Several peers with lower Total (100) received higher overall scores, indicating inconsistency in evaluation application.`
      );
    }

    // 2. outside distribution
    if(!withinDistribution){
      reasons.push(
        `The employee’s Total (100) falls significantly outside the distribution of others receiving the same score.`
      );
    }

    // 3. score group variation
    const highVarGroups = [];
    [1,2,3,4,5].forEach(s=>{
      const vals = group.filter(g=>g.score===s).map(g=>g.total);
      if(vals.length > 1 && stddev(vals) >= VARIATION_STD_THRESHOLD){
        highVarGroups.push(s);
      }
    });
    if(highVarGroups.length){
      reasons.push(
        `Significant variation was observed in score groups ${highVarGroups.join(", ")}, suggesting inconsistent scoring practices.`
      );
    }

    // 4. dept avg
    reasons.push(
      `The department’s average rating of ${avg.toFixed(2)} further indicates irregular scoring patterns.`
    );

    // 5. conclusion
    reasons.push(
      `Accordingly, the APS Team recommends reconsideration of the assigned evaluation score.`
    );

    rec = reasons.join(" ");
  }

  recText.textContent = rec;
  recommendation.style.display="block";
}

</script>

</body>
</html>
