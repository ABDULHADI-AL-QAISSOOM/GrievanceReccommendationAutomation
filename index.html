<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KFUPM Staff Evaluation Analysis Tool</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: #eef2f7;
        }

        header {
            background: linear-gradient(135deg, #0d47a1, #1976d2);
            padding: 30px;
            color: white;
            text-align: center;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 1px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
        }

        .container {
            width: 85%;
            margin: 20px auto;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 14px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-top: 25px;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(10px);}
            to {opacity: 1; transform: translateY(0);}
        }

        h2 {
            color: #0d47a1;
            margin-bottom: 12px;
        }

        input[type=file], input[type=number] {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 15px;
        }

        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 12px;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover {
            background: #0d47a1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 18px;
            font-size: 14px;
        }

        th {
            background: #1976d2;
            color: white;
            padding: 12px;
            text-align: left;
        }

        td {
            border-bottom: 1px solid #ddd;
            padding: 10px;
        }

        .count-box {
            background: #e3f2fd;
            padding: 10px;
            margin-top: 10px;
            border-left: 5px solid #1976d2;
            border-radius: 6px;
        }
    </style>
</head>

<body>

<header>
    KFUPM Staff Evaluation Analysis Tool
</header>

<div class="container">

    <!-- Upload Section -->
    <div class="section">
        <h2>Upload Excel Files</h2>
        <p>Select your 3 evaluation category files:</p>

        <label>Staff Professional</label>
        <input type="file" id="fileProfessional">

        <label>Staff Support</label>
        <input type="file" id="fileSupport">

        <label>Staff Chief</label>
        <input type="file" id="fileChief">

        <button onclick="loadFiles()">Load Files</button>
        <p id="fileStatus" style="color: green; font-weight: 600;"></p>
    </div>

    <!-- Search -->
    <div class="section">
        <h2>Search Employee</h2>
        <input type="number" id="searchID" placeholder="Enter KFUPM ID">
        <button onclick="searchEmployee()">Search</button>
    </div>

    <!-- Employee Info -->
    <div id="employeeInfo" class="section" style="display:none;">
        <h2>Employee Information</h2>
        <p><strong>Name:</strong> <span id="empName"></span></p>
        <p><strong>Department:</strong> <span id="empDept"></span></p>
        <p><strong>Category:</strong> <span id="empCat"></span></p>
        <p><strong>Score:</strong> <span id="empScore"></span></p>
    </div>

    <!-- Department Comparison -->
    <div id="deptComparison" class="section" style="display:none;">
        <h2>Department Comparison</h2>
        <div class="count-box">
            <strong>Total employees in this department (same category):</strong>
            <span id="deptCount"></span>
        </div>

        <table id="deptTable">
            <thead>
                <tr>
                    <th>KFUPM ID</th>
                    <th>Name</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Analysis -->
    <div id="deptAnalysis" class="section" style="display:none;">
        <h2>Department Score Analysis</h2>
        <p><strong>Average Score:</strong> <span id="avgScore"></span></p>

        <canvas id="scoreChart" height="150"></canvas>
    </div>

    <!-- Recommendation -->
    <div id="recommendation" class="section" style="display:none;">
        <h2>Recommendation</h2>
        <p id="recText"></p>
    </div>

</div>

<script>
    let allData = [];
    let categorized = {
        "Professional": [],
        "Support": [],
        "Chief": []
    };

    function loadFiles() {
        const mapping = [
            {file: document.getElementById("fileProfessional").files[0], cat:"Professional"},
            {file: document.getElementById("fileSupport").files[0], cat:"Support"},
            {file: document.getElementById("fileChief").files[0], cat:"Chief"}
        ];

        allData = [];
        mapping.forEach(set => {
            if (!set.file) return;

            const reader = new FileReader();
            reader.onload = e => {
                const workbook = XLSX.read(e.target.result, { type:"binary" });
                const sheet = workbook.SheetNames[0];
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);

                rows.forEach(r => {
                    const entry = {
                        id: String(r["KFUPM ID"]),
                        name: r["Name"],
                        dept: r["Department"],
                        score: Number(r["Overall Score"]),
                        category: set.cat
                    };
                    categorized[set.cat].push(entry);
                    allData.push(entry);
                });
            };
            reader.readAsBinaryString(set.file);
        });

        document.getElementById("fileStatus").innerText = "Files loaded successfully!";
    }

    function searchEmployee() {
        const id = document.getElementById("searchID").value.trim();
        const emp = allData.find(e => e.id === id);

        if (!emp) { alert("Employee not found."); return; }

        // Employee info
        document.getElementById("employeeInfo").style.display = "block";
        empCat.innerText = emp.category;
        empName.innerText = emp.name;
        empDept.innerText = emp.dept;
        empScore.innerText = emp.score;

        // Filter same category + department
        const group = categorized[emp.category].filter(e => e.dept === emp.dept);

        // Count
        document.getElementById("deptCount").innerText = group.length;

        // Sort highest to lowest
        group.sort((a, b) => b.score - a.score);

        // Table
        const tbody = document.querySelector("#deptTable tbody");
        tbody.innerHTML = "";
        group.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>${p.score}</td>
                </tr>`;
        });

        deptComparison.style.display = "block";

        // Analysis
        const avg = group.reduce((s, x) => s + x.score, 0) / group.length;
        avgScore.innerText = avg.toFixed(2);
        deptAnalysis.style.display = "block";

        // Distribution
        const dist = {1:0,2:0,3:0,4:0};
        group.forEach(g => dist[g.score]++);

        drawChart(dist);

        // Recommendation logic
        let rec = "";
        const normal = dist[3] >= Math.max(dist[1], dist[2], dist[4]);

        if (normal) {
            rec = `Based on the department score distribution and the 
            average score of ${avg.toFixed(2)}, the evaluation score appears 
            aligned with peers. No changes are recommended.`;
        } else {
            rec = `The department shows anomalies in score distribution, 
            with an average of ${avg.toFixed(2)}. A reconsideration of 
            the evaluation score is recommended.`;
        }

        recText.innerText = rec;
        recommendation.style.display = "block";
    }

    let chartObj = null;

    function drawChart(dist) {
        if (chartObj) chartObj.destroy();

        const ctx = document.getElementById("scoreChart");
        chartObj = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["1","2","3","4"],
                datasets: [{
                    label: "Score Distribution",
                    data: [dist[1], dist[2], dist[3], dist[4]],
                    backgroundColor: ["#c62828","#ef6c00","#2e7d32","#1565c0"]
                }]
            }
        });
    }
</script>

</body>
</html>
