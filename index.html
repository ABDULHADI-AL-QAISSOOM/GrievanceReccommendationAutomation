<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Evaluation Grievance Analysis</title>

  <!-- Google Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" />

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* your CSS remains unchanged */
    :root{
      --primary:#115f66;
      --secondary:#009767;
      --light-bg:#eef2f7;
      --ink:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0;background:var(--light-bg);color:var(--ink);
    }
    header{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;padding:28px 20px;text-align:center;
      font-size:26px;font-weight:600;letter-spacing:.3px;
      box-shadow:0 6px 20px rgba(0,0,0,.12);
    }
    .container{width:min(1100px,90%);margin:22px auto}
    .section{
      background:var(--card);padding:22px;border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);margin-top:22px;
      animation:fadeIn .35s ease;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    h2{color:var(--primary);margin:0 0 12px}
    p.help{color:var(--muted);margin:6px 0 14px}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=file],input[type=number]{
      width:100%;padding:12px;margin-top:6px;border-radius:10px;border:1px solid #d1d5db;font-size:15px;background:#fff;
    }
    button{
      background:var(--primary);color:#fff;border:none;border-radius:10px;
      padding:12px 20px;font-size:15px;font-weight:600;cursor:pointer;margin-top:12px;
      transition:all .25s ease;box-shadow:0 6px 14px rgba(17,95,102,.25);
    }
    button:hover{background:var(--secondary);transform:translateY(-1px)}
    .status{font-weight:600;color:var(--secondary);margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:14px;font-size:14px}
    thead th{background:var(--primary);color:#fff;padding:12px;text-align:left;position:sticky;top:0}
    tbody td{padding:10px;border-bottom:1px solid #e5e7eb}
    .count-box{
      background:#ddf3e9;border-left:6px solid var(--secondary);
      padding:10px 12px;border-radius:10px;margin:6px 0 12px;font-weight:600;
    }
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge-ok{background:#e8f5e9;color:#1b5e20;border:1px solid #a5d6a7}
    .badge-warn{background:#fff3cd;color:#7a5a00;border:1px solid #ffe69c}
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    canvas{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .small{font-size:13px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fafafa;
    }
  </style>
</head>
<body>

<header>
  Staff Evaluation Grievance Analysis
</header>

<div class="container">

  <!-- Upload section ... unchanged -->
  <!-- Search section ... unchanged -->
  <!-- Employee info ... unchanged -->
  <!-- Department comparison ... unchanged -->
  <!-- Analysis & charts... unchanged -->

  <!-- Recommendation -->
  <div id="recommendation" class="section" style="display:none;">
    <h2>Recommendation</h2>
    <p id="recText"></p>
  </div>
</div>

<script>
/* === All your variables, helper functions, Excel loading, chart functions
       remain unchanged â€” only the CASE 2 part below was upgraded === */

const COLORS = {...};
const TOTAL_DELTA = 2;
const VARIATION_STD_THRESHOLD = 10;

let categorized = { Professional: [], Support: [], Chief: [] };
let allData = [];

/* All previous functions ... unchanged until searchEmployee() */

function searchEmployee() {
  /* ----- Your existing search logic up to recommendation ---- */
  /* I did not modify any of your logic before recommendations */

  /* ------------------------- RECOMMENDATION LOGIC ------------------------- */

  const employeeIsFlagged = flaggedIds.has(emp.id);

  const normal =
    (avg >= 2 && avg <= 3) &&
    (Math.abs(emp.score - avg) <= 1) &&
    !employeeIsFlagged &&
    withinDistribution;

  let rec = "";

  if (normal) {
    /* ===== CASE 1 (unchanged) ===== */
    rec = `Based on the review of the evaluation of the past 3 years and comparison of the employeeâ€™s recent evaluation with peers in the same department, and considering the departmentâ€™s rating average of ${avg.toFixed(2)}, we recommend no changes in the evaluation score.`;
  } else {

    /* =======================================================================
       ðŸ”¥ CASE 2 â€” Intelligent Full Justification (Improved)
    ======================================================================= */
    let reasons = [];

    // (1) Peers with lower totals but higher scores
    const peersLowerTotalHigherScore = group.filter(p =>
      p.total < emp.total && p.score > emp.score
    );
    if (peersLowerTotalHigherScore.length > 0) {
      reasons.push(
        `Several peers with lower Total (100) received higher overall scores, indicating inconsistency in evaluation application.`
      );
    }

    // (2) Employee outside distribution
    if (!withinDistribution) {
      reasons.push(
        `The employeeâ€™s Total (100) falls significantly outside the distribution of others receiving the same overall score.`
      );
    }

    // (3) High variation in score groups
    const highVarGroups = [];
    [1,2,3,4,5].forEach(s => {
      const vals = group.filter(g => g.score === s).map(g => g.total);
      if (vals.length > 1 && stddev(vals) >= VARIATION_STD_THRESHOLD) {
        highVarGroups.push(s);
      }
    });

    if (highVarGroups.length > 0) {
      reasons.push(
        `Significant variation was observed in score groups ${highVarGroups.join(", ")}, suggesting inconsistent scoring practices.`
      );
    }

    // (4) Department average
    reasons.push(
      `The departmentâ€™s average rating of ${avg.toFixed(2)} further indicates irregular scoring patterns.`
    );

    // (5) Final conclusion
    reasons.push(
      `Accordingly, the APS Team recommends reconsideration of the assigned evaluation score.`
    );

    rec = reasons.join(" ");
  }

  document.getElementById("recText").textContent = rec;
  document.getElementById("recommendation").style.display = "block";
}
</script>

</body>
</html>
