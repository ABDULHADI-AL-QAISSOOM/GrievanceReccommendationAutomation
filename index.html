<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Evaluation Grievance Analysis</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" />

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#115f66;
      --secondary:#009767;
      --light-bg:#f3f4f6; 
      --ink:#1f2937;
      --muted:#6b7280;
      --card:#ffffff;
      --border-grey: #e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0;
      background:var(--light-bg);
      color:var(--ink);
      padding-top: 20px;
    }

    /* --- MAIN PAGE HEADER (Solid Command Card) --- */
    header {
      background-color: var(--primary);
      color: #ffffff;
      padding: 35px 20px;
      text-align: center;
      width: min(1100px, 90%);
      margin: 0 auto 30px auto;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(17, 95, 102, 0.25);
      
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.5px;
      text-transform: uppercase;
    }

    .container{width:min(1100px,90%);margin:0 auto 40px auto}
    
    .section{
      background:var(--card);padding:24px;border-radius:16px;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);
      margin-top:24px;
      border: 1px solid rgba(0,0,0,0.02);
      animation:fadeIn .4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    
    h2{color:var(--primary);margin:0 0 12px; font-weight: 700;}
    p.help{color:var(--muted);margin:6px 0 14px}
    label{display:block;margin-top:10px;font-weight:600}
    
    /* General Inputs */
    input[type=file], input[type=number]{
      width:100%;padding:12px;margin-top:6px;border-radius:10px;border:1px solid #d1d5db;font-size:15px;background:#fff;
      transition: border-color 0.2s;
    }
    input:focus { outline:none; border-color: var(--primary); }
    
    button{
      background:var(--primary);color:#fff;border:none;border-radius:10px;
      padding:12px 24px;font-size:15px;font-weight:600;cursor:pointer;margin-top:12px;
      transition:all .2s ease;box-shadow:0 4px 12px rgba(17,95,102,.2);
    }
    button:hover{background:var(--secondary);transform:translateY(-2px); box-shadow:0 6px 15px rgba(0,151,103,.3);}
    
    .status{font-weight:600;color:var(--secondary);margin-top:10px}
    .count-box{ background:#ddf3e9;border-left:6px solid var(--secondary); padding:12px 16px;border-radius:8px;margin:6px 0 16px;font-weight:600; }
    
    /* --- TABLE STYLING: WHITE GLASS --- */
    table { width:100%; border-collapse:separate; border-spacing: 0; margin-top:14px; font-size:14px; }
    
    thead {
        position: sticky;
        top: 0;
        z-index: 10;
        /* Subtle shadow for the floating effect */
        box-shadow: 0 4px 20px rgba(0,0,0,0.06); 
        border-radius: 16px;
    }

    /* THE GLASS EFFECT APPLIED TO TH */
    thead th {
        /* Semi-transparent White */
        background: rgba(255, 255, 255, 0.85); 
        
        /* Blur Effect */
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        
        /* Text Color is now TEAL (Reversed) */
        color: var(--primary);
    }

    /* Row 1: Labels (Larger & Centered) */
    thead tr:first-child th {
        padding: 20px 16px 10px 16px;
        
        /* Centered Alignment */
        text-align: center; 
        
        font-weight: 800; /* Extra Bold */
        text-transform: uppercase;
        
        /* Increased Size */
        font-size: 15px; 
        
        letter-spacing: 0.5px;
        cursor: pointer;
        user-select: none;
        border-bottom: none;
    }
    thead tr:first-child th:hover {
        background: rgba(255, 255, 255, 1); /* Solid white on hover */
        color: var(--secondary); /* Green highlight on hover */
    }

    /* Row 2: Filters */
    thead tr:last-child th {
        padding: 4px 16px 24px 16px;
        /* Grey bottom border */
        border-bottom: 4px solid #e5e7eb; 
    }

    /* INPUTS ON WHITE BACKGROUND */
    #filterRow input, #filterRow select {
        width: 100%;
        padding: 8px 16px; 
        margin-top: 4px;
        border-radius: 99px; /* Pill Shape */
        
        /* Light Grey Border */
        border: 1px solid #d1d5db; 
        
        /* White Background */
        background: #ffffff; 
        
        color: var(--ink);
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
        text-align: center; /* Center text inside inputs too */
    }
    #filterRow input::placeholder {
        color: #9ca3af;
    }
    #filterRow input:focus, #filterRow select:focus {
        background: #fff;
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(17, 95, 102, 0.1); /* Teal Glow */
    }
    
    /* Rounded corners for the Header Block */
    thead tr:first-child th:first-child { border-top-left-radius: 16px; }
    thead tr:first-child th:last-child { border-top-right-radius: 16px; }

    /* Body */
    tbody td { 
        padding: 16px; 
        border-bottom: 1px solid #f3f4f6; 
        color: var(--ink); 
        vertical-align: middle;
        text-align: center; /* Center body text to match headers */
    }
    /* Align Name column to left for readability */
    tbody td:nth-child(2) { text-align: left; padding-left: 24px; }
    thead tr:first-child th:nth-child(2) { text-align: left; padding-left: 24px; } /* Match header to left */

    tbody tr:hover { background-color: #f9fafb; }
    /* --- END TABLE --- */

    .badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:700}
    .badge-ok{background:#e8f5e9;color:#1b5e20;border:1px solid #c8e6c9}
    .badge-warn{background:#fff8e1;color:#b08d00;border:1px solid #ffecb3}
    
    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    
    canvas{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .small{font-size:13px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 12px;border-radius:99px;border:1px solid #e5e7eb;background:#f9fafb; font-weight: 500;
    }

    .signature {
      text-align: center;
      margin-top: 50px;
      margin-bottom: 20px;
      color: var(--primary);
      font-size: 15px; 
      font-weight: 600;
      opacity: 0.7;
      font-family: 'Courier New', Courier, monospace; 
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }
  </style>
</head>
<body>

<header>
  Staff Evaluation Grievance Analysis
</header>

<div class="container">

  <div style="text-align: right;">
    <button id="exportDashboardBtn" onclick="printFullReport()" style="margin-top:0;">Export Full Report </button>
  </div>

  <div class="section">
    <h2>Upload Excel Files</h2>
    <p class="help">
      Please upload the staff category files in their original format (from APS) without alterations.<br>
    </p>

    <label>Staff Professional</label>
    <input type="file" id="fileProfessional" accept=".xlsx,.xls" />

    <label>Staff Support</label>
    <input type="file" id="fileSupport" accept=".xlsx,.xls" />

    <label>Staff Chief</label>
    <input type="file" id="fileChief" accept=".xlsx,.xls" />

    <button onclick="loadFiles()">Load Files</button>
    <div id="fileStatus" class="status"></div>
  </div>

  <div class="section">
    <h2>Search Employee</h2>
    <div class="flex">
      <input type="number" id="searchID" placeholder="Enter KFUPM ID" />
      <button onclick="searchEmployee()">Search</button>
    </div>
    <p class="small muted">Comparison includes employees from the <strong>same Department</strong> and the <strong>same Category</strong>.</p>
  </div>

  <div id="employeeInfo" class="section" style="display:none;">
    <h2>Employee Information</h2>
    <div class="flex">
      <div class="pill"><strong>Name:</strong> <span id="empName"></span></div>
      <div class="pill"><strong>Department:</strong> <span id="empDept"></span></div>
      <div class="pill"><strong>Category:</strong> <span id="empCat"></span></div>
      <div class="pill"><strong>Overall Score:</strong> <span id="empScore"></span></div>
      <div class="pill"><strong>Total (100):</strong> <span id="empTotal"></span></div>
    </div>
  </div>

  <div id="deptComparison" class="section" style="display:none;">
    <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin:0;">Overall Department's Scores</h2>
        <button onclick="printDepartmentTable()" style="margin:0; background:#115f66;">Export Table</button>
    </div>
    <div class="count-box">
      Employees in this department (same category): <span id="deptCount"></span>
    </div>

    <table id="deptTable">
      <thead>
        <tr>
          <th data-col="id">KFUPM ID</th>
          <th data-col="name">Name</th>
          <th data-col="total">Total (100)</th>
          <th data-col="score">Overall Score</th>
          <th data-col="flag">Flag</th>
        </tr>
        <tr id="filterRow">
          <th><input type="text" id="filterID" placeholder="Filter..." class="small"></th>
          <th><input type="text" id="filterName" placeholder="Filter..." class="small"></th>
          <th><input type="text" id="filterTotal" placeholder="Filter..." class="small"></th>
          <th><input type="text" id="filterScore" placeholder="Filter..." class="small"></th>
          <th>
            <select id="filterFlag" class="small">
              <option value="">All</option>
              <option value="OK">OK</option>
              <option value="Inconsistent">Inconsistent</option>
            </select>
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="deptAnalysis" class="section" style="display:none;">
    <h2>Department Score Analysis</h2>
    <div class="flex small muted">
      <div><strong>Average Overall Score:</strong> <span id="avgScore"></span></div>
    </div>

    <div class="grid" style="margin-top:10px;">
      <div>
        <p class="small muted"><strong>Overall Score Distribution</strong> (1–5)</p>
        <canvas id="scoreChart" height="180"></canvas>
      </div>
      <div>
        <p class="small muted"><strong>Total (100) Distribution</strong> (0–100, binned)</p>
        <canvas id="totalChart" height="180"></canvas>
      </div>
    </div>
  </div>

  <div id="byScoreSection" class="section" style="display:none;">
    <h2>Total (100) by Overall Score</h2>
    <p class="small muted">These views show how Total (100) varies within each overall score group.</p>

    <div class="grid" style="margin-top:10px;">
      <div>
        <p class="small muted"><strong>Grouped Histogram</strong> — Total (100) distribution per score</p>
        <canvas id="totalByScoreChart" height="200"></canvas>
      </div>
      <div>
        <p class="small muted"><strong>Scatter (Jitter)</strong> — Total (100) vs Overall Score</p>
        <canvas id="scatterChart" height="200"></canvas>
      </div>
    </div>

    <div id="variationBadges" class="flex small" style="margin-top:10px;"></div>
  </div>

  <div id="recommendation" class="section" style="display:none;">
    <h2>Recommendation</h2>
    <p id="recText"></p>
  </div>

  <div class="signature">
    Designed π Hadi
  </div>

</div>

<script>
  // ====== Config ======
  const COLORS = {
    primary: "#115f66",
    secondary: "#009767",
    cat1: "#c62828", 
    cat2: "#ef6c00", 
    cat3: "#009767", 
    cat4: "#115f66", 
    cat5: "#6a1b9a" 
  };
  const TOTAL_DELTA = 2; 
  const VARIATION_STD_THRESHOLD = 10; 

  // ====== State ======
  let categorized = { Professional: [], Support: [], Chief: [] };
  let allData = [];
  let scoreChartObj = null;
  let totalChartObj = null;
  let totalByScoreChartObj = null;
  let scatterChartObj = null;

  // ====== Excel Loading ======
  function readExcelFile(file, category){
    return new Promise((resolve, reject) => {
      if(!file) return resolve([]);
      const reader = new FileReader();
      reader.onload = e => {
        try{
          const workbook = XLSX.read(e.target.result, { type:"binary" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);
          const cleaned = rows.map(r => ({
            id: String(r["KFUPM ID"] ?? "").trim(),
            name: String(r["Name"] ?? "").trim(),
            dept: String(r["Department"] ?? "").trim(),
            score: Number(r["Overall Score"]),
            total: Number(r["Total (100)"]),
            category
          })).filter(x => x.id && x.name && x.dept && !Number.isNaN(x.score) && !Number.isNaN(x.total));
          resolve(cleaned);
        }catch(err){ reject(err); }
      };
      reader.onerror = reject;
      reader.readAsBinaryString(file);
    });
  }

  async function loadFiles(){
    const professional = document.getElementById("fileProfessional").files[0];
    const support = document.getElementById("fileSupport").files[0];
    const chief = document.getElementById("fileChief").files[0];

    const status = document.getElementById("fileStatus");
    status.textContent = "Loading files...";

    try{
      const [proData, supData, chfData] = await Promise.all([
        readExcelFile(professional, "Professional"),
        readExcelFile(support, "Support"),
        readExcelFile(chief, "Chief"),
      ]);

      categorized = { Professional: proData, Support: supData, Chief: chfData };
      allData = [...proData, ...supData, ...chfData];

      const totalCount = allData.length;
      status.textContent = `Files loaded successfully. Total records: ${totalCount} (Professional: ${proData.length}, Support: ${supData.length}, Chief: ${chfData.length}).`;

    }catch(err){
      console.error(err);
      status.textContent = "Error loading files. Please check the format and try again.";
    }
  }

  // ====== Utilities ======
  function mean(arr){ if(arr.length===0) return 0; return arr.reduce((a,b)=>a+b,0)/arr.length; }
  function stddev(arr){
    if(arr.length<=1) return 0;
    const m = mean(arr);
    const v = arr.reduce((s,x)=>s + Math.pow(x-m,2),0) / (arr.length-1);
    return Math.sqrt(v);
  }
  function binCounts(values, bins){
    const counts = new Array(bins.length).fill(0);
    values.forEach(v=>{
      for(let i=0;i<bins.length;i++){
        const [min,max] = bins[i];
        if(v>=min && v<=max){ counts[i]++; break; }
      }
    });
    return counts;
  }

  // ====== Main Search & Analysis ======
  function searchEmployee(){
    const id = String(document.getElementById("searchID").value || "").trim();
    if(!id){ alert("Please enter a KFUPM ID."); return; }

    const emp = allData.find(e => e.id === id);
    if(!emp){ alert("Employee not found."); return; }

    // Display employee info
    document.getElementById("employeeInfo").style.display = "block";
    document.getElementById("empName").textContent = emp.name;
    document.getElementById("empDept").textContent = emp.dept;
    document.getElementById("empCat").textContent = emp.category;
    document.getElementById("empScore").textContent = emp.score;
    document.getElementById("empTotal").textContent = emp.total;

    // Group: same category + same department
    const group = categorized[emp.category].filter(e => e.dept === emp.dept);

    // Count
    document.getElementById("deptCount").textContent = group.length;

    // Flagging inconsistencies (Total vs Score)
    const flaggedIds = new Set();
    group.forEach(p=>{
      const peersSimilarTotal = group.filter(q => q.id !== p.id && Math.abs(q.total - p.total) <= TOTAL_DELTA);
      const higherOverallExists = peersSimilarTotal.some(q => q.score > p.score);
      const higherTotalLowerScore = group.some(q => (p.total - q.total) > TOTAL_DELTA && p.score < q.score);
      if(higherOverallExists || higherTotalLowerScore){
        flaggedIds.add(p.id);
      }
    });

    // Sort table by score desc, then total desc
    group.sort((a,b)=> b.score - a.score || b.total - a.total);

    // Save table data for sorting/filtering and render via the engine
    lastDeptGroup = group.map(p => ({
      id: p.id,
      name: p.name,
      total: p.total,
      score: p.score,
      flagged: flaggedIds.has(p.id) // boolean
    }));

    applyFiltersAndSorting();

    document.getElementById("deptComparison").style.display = "block";

    // Department analysis (overall)
    const avg = group.reduce((s,x)=>s + x.score, 0) / (group.length || 1);
    document.getElementById("avgScore").textContent = isFinite(avg) ? avg.toFixed(2) : "—";
    document.getElementById("deptAnalysis").style.display = "block";

    // Score distribution 1..5
    const scoreDist = {1:0,2:0,3:0,4:0,5:0};
    group.forEach(g => { if(scoreDist[g.score] !== undefined) scoreDist[g.score]++; });
    drawScoreChart(scoreDist);

    // Total (100) distribution overall (binned)
    const totalBins = [[0,20],[21,40],[41,60],[61,80],[81,100]];
    const totalCounts = binCounts(group.map(g=>g.total), totalBins);
    drawTotalChart(totalBins, totalCounts);

    // Per-score totals (grouped histogram + scatter + variation badges)
    drawTotalByScoreCharts(group, totalBins);

    // --- NEW RULE: within-distribution check for employee's score group ---
    const sameScoreTotals = group.filter(g => Number(g.score) === Number(emp.score)).map(g => g.total);
    let withinDistribution = true;
    if (sameScoreTotals.length > 2) {
      const sd = stddev(sameScoreTotals);
      const avgSameScore = mean(sameScoreTotals);
      const minAllowed = avgSameScore - sd;
      const maxAllowed = avgSameScore + sd;
      if (emp.total < minAllowed || emp.total > maxAllowed) {
        withinDistribution = false;
      }
    }

    // Recommendation logic
    const employeeIsFlagged = flaggedIds.has(emp.id);
    const normal =
      (avg >= 2 && avg <= 3) &&                
      (Math.abs(emp.score - avg) <= 1) &&      
      !employeeIsFlagged &&                    
      withinDistribution;                      

    let rec = "";
    if (normal) {
      rec = `Based on the review of the evaluation of the past 3 years and comparison of the employee’s recent evaluation with peers in the same department, and considering the department’s rating average of ${avg.toFixed(2)}, we recommend no changes in the evaluation score.`;
    } else {
      let reasons = [];
      const peersWithLowerTotalHigherScore = group.filter(p => p.total < emp.total && p.score > emp.score);
      if (peersWithLowerTotalHigherScore.length > 0) {
        reasons.push(`Several peers with lower Total (100) received higher overall scores, indicating inconsistency in evaluation application.`);
      }
      if (!withinDistribution) {
        reasons.push(`The employee’s Total (100) falls significantly outside the distribution of others who received the same overall score.`);
      }
      const highVarGroups = [];
      [1, 2, 3, 4, 5].forEach(s => {
        const vals = group.filter(g => g.score === s).map(g => g.total);
        if (vals.length > 1 && stddev(vals) >= VARIATION_STD_THRESHOLD) {
          highVarGroups.push(s);
        }
      });
      if (highVarGroups.length > 0) {
        reasons.push(`Significant variation was observed within score groups ${highVarGroups.join(", ")}, suggesting inconsistent scoring practices.`);
      }
      reasons.push(`The department’s average rating of ${avg.toFixed(2)} further indicates irregular scoring patterns.`);
      reasons.push(`Accordingly, the APS Team recommends reconsideration of the assigned evaluation score.`);
      rec = reasons.join(" ");
    }
    
    document.getElementById("recText").textContent = rec;
    document.getElementById("recommendation").style.display = "block";
  }

  // --- ENTER KEY TO SEARCH FUNCTIONALITY ---
  document.getElementById("searchID").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      event.preventDefault(); 
      searchEmployee();
    }
  });

  // ====== Charts ======
  function drawScoreChart(dist){
    if(scoreChartObj) scoreChartObj.destroy();
    const ctx = document.getElementById("scoreChart");
    scoreChartObj = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["1","2","3","4","5"],
        datasets: [{
          label: "Count",
          data: [dist[1], dist[2], dist[3], dist[4], dist[5]],
          backgroundColor: [COLORS.cat1, COLORS.cat2, COLORS.cat3, COLORS.cat4, COLORS.cat5],
          borderRadius: 6
        }]
      },
      options: {
        plugins:{ legend:{ display:false }},
        scales:{
          y:{ beginAtZero:true, ticks:{ precision:0 } },
          x:{ grid:{ display:false } }
        }
      }
    });
  }

  function drawTotalChart(bins, counts){
    if(totalChartObj) totalChartObj.destroy();
    const ctx = document.getElementById("totalChart");
    totalChartObj = new Chart(ctx, {
      type: "bar",
      data: {
        labels: bins.map(b => `${b[0]}–${b[1]}`),
        datasets: [{
          label: "Count",
          data: counts,
          backgroundColor: COLORS.primary,
          borderRadius: 6
        }]
      },
      options: {
        plugins:{ legend:{ display:false }},
        scales:{
          y:{ beginAtZero:true, ticks:{ precision:0 }},
          x:{ grid:{ display:false }}
        }
      }
    });
  }

  function drawTotalByScoreCharts(group, bins){
    document.getElementById("byScoreSection").style.display = "block";
    const totalsByScore = {1:[],2:[],3:[],4:[],5:[]};
    group.forEach(g => {
      const s = Number(g.score);
      if (totalsByScore[s]) totalsByScore[s].push(g.total);
    });

    const datasets = [1,2,3,4,5].map(s => {
      const color = [COLORS.cat1, COLORS.cat2, COLORS.cat3, COLORS.cat4, COLORS.cat5][s-1];
      return {
        label: `Score ${s}`,
        backgroundColor: color + "cc",
        borderColor: color,
        data: binCounts(totalsByScore[s], bins)
      };
    });

    if(totalByScoreChartObj) totalByScoreChartObj.destroy();
    totalByScoreChartObj = new Chart(document.getElementById("totalByScoreChart"), {
      type: "bar",
      data: { labels: bins.map(b=>`${b[0]}–${b[1]}`), datasets },
      options: {
        responsive:true,
        plugins:{ legend:{ position:"top" } },
        scales: {
          y:{ beginAtZero:true, ticks:{ precision:0 } },
          x:{ stacked:false, grid:{ display:false } }
        }
      }
    });

    const scatterDatasets = [1,2,3,4,5].map(s => {
      const color = [COLORS.cat1, COLORS.cat2, COLORS.cat3, COLORS.cat4, COLORS.cat5][s-1];
      const points = totalsByScore[s].map(v => ({ x: s + (Math.random()-0.5)*0.2, y: v }));
      return {
        label: `Score ${s}`,
        data: points,
        backgroundColor: color,
        borderColor: color,
        showLine: false,
        pointRadius: 4
      };
    });

    if(scatterChartObj) scatterChartObj.destroy();
    scatterChartObj = new Chart(document.getElementById("scatterChart"), {
      type: "scatter",
      data: { datasets: scatterDatasets },
      options: {
        plugins:{ legend:{ position:"top" } },
        scales: {
          x: { type: "linear", min: 0.5, max: 5.5, ticks: { stepSize: 1, callback: (v)=> [1,2,3,4,5].includes(v) ? v : "" }, title: { display:true, text:"Overall Score" }, grid:{ display:false } },
          y: { min: 0, max: 100, title: { display:true, text:"Total (100)" }, beginAtZero: true }
        }
      }
    });

    const vb = document.getElementById("variationBadges");
    vb.innerHTML = "";
    [1,2,3,4,5].forEach(s=>{
      const vals = totalsByScore[s];
      if(vals.length === 0) return;
      const sd = stddev(vals);
      const cl = sd >= VARIATION_STD_THRESHOLD ? "badge-warn" : "badge-ok";
      const label = sd >= VARIATION_STD_THRESHOLD ? "High variation" : "Low variation";
      vb.insertAdjacentHTML("beforeend", `<span class="badge ${cl}" title="Std Dev = ${sd.toFixed(1)} for score ${s}">Score ${s}: ${label} (σ=${sd.toFixed(1)})</span>`);
    });
  }

  // ============================ SORTING & FILTERING ENGINE ============================
  let currentSort = { column: 'score', asc: false };
  let lastDeptGroup = [];
  const COL_MAP = { id: 'id', name: 'name', total: 'total', score: 'score', flag: 'flagged' };

  function applyFiltersAndSorting() {
    const tbody = document.querySelector("#deptTable tbody");
    if (!tbody) return;
    tbody.innerHTML = "";

    const fID = (document.getElementById("filterID")?.value || "").toLowerCase();
    const fName = (document.getElementById("filterName")?.value || "").toLowerCase();
    const fTotal = (document.getElementById("filterTotal")?.value || "").trim();
    const fScore = (document.getElementById("filterScore")?.value || "").trim();
    const fFlag = (document.getElementById("filterFlag")?.value || "").trim();

    let rows = lastDeptGroup.filter(r => {
      const flagText = r.flagged ? "Inconsistent" : "OK";
      return (
        (fID === "" || String(r.id).toLowerCase().includes(fID)) &&
        (fName === "" || String(r.name).toLowerCase().includes(fName)) &&
        (fTotal === "" || String(r.total).includes(fTotal)) &&
        (fScore === "" || String(r.score).includes(fScore)) &&
        (fFlag === "" || flagText === fFlag)
      );
    });

    if (currentSort.column) {
      const key = COL_MAP[currentSort.column] || currentSort.column;
      rows.sort((a, b) => {
        let v1 = a[key];
        let v2 = b[key];
        if (key === 'id' || key === 'name') { v1 = String(v1).toLowerCase(); v2 = String(v2).toLowerCase(); }
        else if (key === 'total' || key === 'score') { v1 = Number(v1); v2 = Number(v2); }
        else if (key === 'flagged') { v1 = !!v1; v2 = !!v2; }
        if (v1 < v2) return currentSort.asc ? -1 : 1;
        if (v1 > v2) return currentSort.asc ?  1 : -1;
        return 0;
      });
    }

    rows.forEach(r => {
      const badge = r.flagged ? `<span class="badge badge-warn">⚠ Inconsistent</span>` : `<span class="badge badge-ok">✓ OK</span>`;
      tbody.insertAdjacentHTML("beforeend", `<tr><td>${r.id}</td><td>${r.name}</td><td>${r.total}</td><td>${r.score}</td><td>${badge}</td></tr>`);
    });
  }

  document.querySelectorAll("#deptTable thead tr:first-child th").forEach(th => {
    th.style.cursor = "pointer";
    th.addEventListener("click", () => {
      const col = th.dataset.col;
      if (!col) return;
      if (currentSort.column === col) { currentSort.asc = !currentSort.asc; }
      else { currentSort.column = col; currentSort.asc = (col === 'id' || col === 'name' || col === 'flag') ? true : false; }
      applyFiltersAndSorting();
    });
  });

  document.querySelectorAll("#filterRow input, #filterRow select").forEach(el => {
    el.addEventListener("input", applyFiltersAndSorting);
  });

  // ========================= 1. PRINT FULL REPORT (POP-OUT) =========================
  function printFullReport() {
    // Safety check: Don't print if no data exists
    if(document.getElementById('deptComparison').style.display === 'none'){
        alert("Please search for an employee first to generate a report.");
        return;
    }

    // Open a new window
    const printWindow = window.open('', '', 'height=900,width=1000');
    
    // Begin writing HTML
    printWindow.document.write('<html><head><title>Staff Evaluation Grievance Analysis</title>');
    printWindow.document.write('<style>');
    printWindow.document.write(`
        body { font-family: 'Inter', sans-serif; padding: 40px; color: #000; background: #fff; }
        
        /* HEADER STYLE FOR PRINT */
        h1 { 
          text-align: center; 
          color: #ffffff; 
          background: #115f66; 
          padding: 30px 20px; 
          margin-bottom: 30px; 
          font-size: 24px;
          border-radius: 16px; 
        }

        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ccc; border-radius: 8px; page-break-inside: avoid; }
        h2 { color: #115f66; margin-top: 0; }
        /* Clean Tables */
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th { background-color: #115f66; color: white; padding: 8px; text-align: left; border: 1px solid #115f66; }
        td { padding: 8px; border: 1px solid #ddd; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        /* Badges */
        .badge { padding: 4px 8px; border-radius: 99px; font-weight: bold; font-size: 11px; display: inline-block; border: 1px solid #ccc; }
        .pill { display: inline-block; padding: 5px 10px; border: 1px solid #ccc; border-radius: 20px; margin-right: 10px; background: #f5f5f5; }
        .flex { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        /* Chart Images */
        img { max-width: 100%; display: block; margin: 0 auto; }
        
        /* SIGNATURE STYLE FOR PRINT */
        .signature-print { 
          text-align: center; 
          margin-top: 50px; 
          color: #115f66;
          font-size: 16px; 
          font-weight: 600; 
          font-family: 'Courier New', Courier, monospace; 
          letter-spacing: 1px;
          text-transform: uppercase;
        }
    `);
    printWindow.document.write('</style></head><body>');

    printWindow.document.write('<h1>Staff Evaluation Grievance Analysis</h1>');

    // Helper to clone and process visible sections
    function addSectionToPrint(id) {
        const original = document.getElementById(id);
        if (original && original.style.display !== 'none') {
            const clone = original.cloneNode(true);

            // Remove interactive elements
            clone.querySelectorAll('button').forEach(b => b.remove());
            const filterRow = clone.querySelector('#filterRow');
            if(filterRow) filterRow.remove();

            // CONVERT CANVAS TO IMAGES (Crucial for printing charts)
            const origCanvases = original.querySelectorAll('canvas');
            const cloneCanvases = clone.querySelectorAll('canvas');
            origCanvases.forEach((orig, i) => {
                if (cloneCanvases[i]) {
                    const img = document.createElement('img');
                    img.src = orig.toDataURL('image/jpeg', 1.0);
                    cloneCanvases[i].parentNode.replaceChild(img, cloneCanvases[i]);
                }
            });

            printWindow.document.write('<div class="section">');
            printWindow.document.write(clone.innerHTML);
            printWindow.document.write('</div>');
        }
    }

    addSectionToPrint('employeeInfo');
    addSectionToPrint('deptComparison');
    addSectionToPrint('deptAnalysis');
    addSectionToPrint('byScoreSection');
    addSectionToPrint('recommendation');

    printWindow.document.write('<div class="signature-print">Designed π Hadi</div>');

    printWindow.document.write('</body></html>');
    printWindow.document.close();

    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 250); 
  }


  // ========================= 2. TABLE PDF EXPORT (PRINT STYLE) ========================= 
  function printDepartmentTable() {
    const originalTable = document.getElementById("deptTable");
    const tableClone = originalTable.cloneNode(true);
    const filterRow = tableClone.querySelector("#filterRow");
    if (filterRow) filterRow.remove();

    const printWindow = window.open('', '', 'height=800,width=900');
    printWindow.document.write('<html><head><title>Department Scores Report</title><style>');
    printWindow.document.write(`
        body { font-family: 'Inter', sans-serif; padding: 40px; color: #1f2937; }
        h1 { text-align: center; color: #115f66; margin-bottom: 30px; font-size: 24px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background-color: #115f66; color: white; padding: 12px 8px; text-align: left; border: 1px solid #115f66; }
        td { padding: 10px 8px; border: 1px solid #e5e7eb; }
        tr:nth-child(even) { background-color: #f9fafb; }
        .badge { padding: 4px 8px; border-radius: 99px; font-weight: bold; font-size: 11px; display: inline-block; }
        .badge-ok { background:#e8f5e9; color:#1b5e20; border:1px solid #a5d6a7; }
        .badge-warn { background:#fff3cd; color:#7a5a00; border:1px solid #ffe69c; }
    `);
    printWindow.document.write('</style></head><body>');
    printWindow.document.write('<h1>Overall Department\'s Scores</h1>');
    printWindow.document.write(tableClone.outerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();

    printWindow.focus();
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
  }
</script>

</body>
</html>
